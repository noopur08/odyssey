<html>

<head>
    <title>The Space Odyssey X</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@zxing/library@0.16.0/umd/index.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        @import url("https://fonts.googleapis.com/css?family=Montserrat");

        * {
            font-family: "Montserrat", sans-serif;
        }

        body {
            background-color: #9972c6;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
        }

        #previewcontainer {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            position: fixed;
        }

        #preview {
            background: transparent;
            border: 5px solid transparent;
            border-radius: 20px;
            z-index: 1;
        }

        #iframecontainer {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            position: fixed;
        }

        #iframe {
            background: transparent;
            border: 5px solid transparent;
            border-radius: 20px;
            z-index: 1;
            height: 80vh;
            width: 80vw;
        }

        #imagecontainer {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            position: fixed;
        }

        #image {
            background: transparent;
            border: 5px solid transparent;
            border-radius: 20px;
            z-index: 1;
            height: 80vh;
            width: 80vw;
        }

        #output {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            display: none;
            padding: 50px;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 36px;
            color: white;
            background-color: #ee6b3a;
            z-index: 2;
        }

        #thankyou {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #225ba1;
            background-color: #d7e0e8;
            z-index: 2;
        }

        #rescanbutton {
            background: #225ba1;
            border: none;
            border-radius: 50%;
            z-index: 10;
            padding: 15px;
            color: white;
            font-weight: 900;
            font-size: 25px;
            text-decoration: none;
            position: fixed;
            right: 20px;
            bottom: 20px;
            cursor: pointer;
        }

        #infobutton {
            background: #225ba1;
            border: none;
            border-radius: 50%;
            z-index: 10;
            padding: 15px;
            color: white;
            font-weight: 900;
            font-size: 25px;
            text-decoration: none;
            position: fixed;
            left: 20px;
            bottom: 20px;
            cursor: pointer;
        }

        #link {
            background: #225ba1;
            border: none;
            border-radius: 50%;
            z-index: 10;
            padding: 15px;
            color: white;
            font-weight: 900;
            font-size: 25px;
            text-decoration: none;
            position: fixed;
            right: 95px;
            bottom: 20px;
        }

        #headingcontainer {
            display: flex;
            align-items: center;
            justify-content: center;
            top: 0;
        }

        #heading {
            color: white;
            text-align: center;
            font-weight: 900;
            background: #225ba1;
            border-radius: 0 0 20px 20px;
            font-size: 25px;
            padding: 20px;
            z-index: 10;
            top: 0px;
            position: fixed;
        }

        #infocontainer {
            position: fixed;
            width: 33%;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 12px 12px 0 0;
            background-color: #225ba1;
            color: white;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 999;
            bottom: -100%;
            transition: bottom 0.7s ease-in-out;
            padding: 0 20px 30px 20px;
            line-height: 20px;
        }

        #infocontainer.show {
            bottom: 0;
        }

        #infocontainer h2 {
            text-align: center;
            font-weight: 900;
            color: white;
        }

        #infocontainer p {
            text-align: justify;
            font-size: 15px;
        }

        @media screen and (max-width: 768px) {
            #infocontainer {
                left: 0 !important;
                right: 0 !important;
                width: auto !important;
                transform: none !important;
            }
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.7s ease-in-out;
            pointer-events: none;
        }

        #overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        #cancelbutton {
            color: white;
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: solid 1px;
            cursor: pointer;
            font-size: 20px;
            border-radius: 50%;
        }
    </style>


</head>

<body>
    <div id="headingcontainer">
        <div id="heading">Odyssey - Find the "X"</div>
    </div>
    <div id="previewcontainer">
        <video id="preview"></video>
    </div>
    <div id="output"></div>
    <div id="thankyou">Thank you for playing!</div>
    <div id="overlay"></div>
    <div id="infocontainer">
        <button id="cancelbutton"><i class="fa fa-times" aria-hidden="true"></i></button>
        <h2>The Space Odyssey X</h2>
        <p>Welcome to the most thrilling event organized by FMaC! This isn't just any treasure hunt; it's a cinematic adventure through time and space! <br><br>
            <i>Travel through different eras, from ancient civilizations to futuristic dystopias, facing challenges at every turn. Watch out for zombies, solve puzzles, and avoid being captured as a prisoner in this race against time. Use your wits and agility to scan QR codes, gather clues, and outsmart your opponents to reach the final destination before time runs out!</i>
            <br><br>Prepare yourself for a journey like no other and check out the rulebook cum brochure here.
         </p>
    </div>
    <button id="infobutton"><i class="fa fa-info-circle" aria-hidden="true"></i></button>
    <button id="rescanbutton" onclick="location.reload()" title="Reload"><i class="fa fa-refresh"
            aria-hidden="true"></i></button>
    <script>
        document.getElementById("infobutton").addEventListener('click', () => {
            document.getElementById("infocontainer").classList.toggle("show");
            document.getElementById("overlay").classList.toggle("show");
        });
        document.getElementById("overlay").addEventListener('click', () => {
            document.getElementById("infocontainer").classList.remove("show");
            document.getElementById("overlay").classList.remove("show");
        });
        document.getElementById("cancelbutton").addEventListener('click', () => {
            document.getElementById("infocontainer").classList.remove("show");
            document.getElementById("overlay").classList.remove("show");
        });
        const firebaseConfig = {
            apiKey: "{{APIKEY}}",
            authDomain: "usual-queries-1609431206290.firebaseapp.com",
            databaseURL: "https://usual-queries-1609431206290-default-rtdb.firebaseio.com",
            projectId: "usual-queries-1609431206290",
            storageBucket: "usual-queries-1609431206290.appspot.com",
            messagingSenderId: "697780997655",
            appId: "1:697780997655:web:82425b31582d765648d652"
        };
        firebase.initializeApp(firebaseConfig);
        let scanTimer;
        const codeReader = new ZXing.BrowserQRCodeReader();
        function startScanTimer() {
            scanTimer = setTimeout(() => {
                location.reload();
            }, 300000);
        }
        function resetScanTimer() {
            clearTimeout(scanTimer);
            startScanTimer();
        }
        firebase.database().ref('QRs').child('qrs').once('value').then(function (snapshot) {
            const round0 = [snapshot.val().r0q1, snapshot.val().r0q2, snapshot.val().r0q3, snapshot.val().r0q4, snapshot.val().r0q5, snapshot.val().r0q6];
            const password = ['pass1', 'pass2', 'pass3', 'pass4', 'pass5', 'pass6', 'pass7', 'pass8', 'pass9', 'pass10', 'pass11', 'pass12', 'pass13', 'pass14', 'pass15', 'pass16', 'pass17', 'pass18','pass19','pass19','pass19', 'pass20', 'pass20', 'pass20'];
            const round1 = [snapshot.val().r1q1, snapshot.val().r1q2, snapshot.val().r1q3, snapshot.val().r1q4, snapshot.val().r1q5, snapshot.val().r1q6, snapshot.val().r1q7, snapshot.val().r1q8]; // 3 
            const round1teams = [];
            const round1teamssplice = []; // 6 + 2
            const round2 = [snapshot.val().r2q1, snapshot.val().r2q2, snapshot.val().r2q3, snapshot.val().r2q4];
            const round2teams = []; // 4
            const round3 = [snapshot.val().r3q1, snapshot.val().r3q2];
            const round3teams = []; // 2
            const round4 = [snapshot.val().q1, snapshot.val().q2, snapshot.val().q3, snapshot.val().q4, snapshot.val().q5, snapshot.val().q6, snapshot.val().q7, snapshot.val().q8, snapshot.val().q9, snapshot.val().q10, snapshot.val().q11, snapshot.val().q12, snapshot.val().q13, snapshot.val().q14, snapshot.val().q15, snapshot.val().q16, snapshot.val().q17, snapshot.val().q18, snapshot.val().q19, snapshot.val().q20, snapshot.val().q21, snapshot.val().q22, snapshot.val().q23, snapshot.val().q24, snapshot.val().q25, snapshot.val().q26, snapshot.val().q27, snapshot.val().q28, snapshot.val().q29, snapshot.val().q30, snapshot.val().q31, snapshot.val().q32, snapshot.val().q33, snapshot.val().q34, snapshot.val().q35, snapshot.val().q36, snapshot.val().q37, snapshot.val().q38, snapshot.val().q39, snapshot.val().q40, snapshot.val().q41, snapshot.val().q42, snapshot.val().q43, snapshot.val().q44, snapshot.val().q45, snapshot.val().q46, snapshot.val().q47, snapshot.val().q48, snapshot.val().q49, snapshot.val().q50, snapshot.val().q51];
            const huntstarttime = '2023-03-25T17:15:00+05:30';
            const round0endtime = '2023-03-25T17:35:00+05:30';
            const round1endtime = '2023-03-25T18:10:00+05:30';
            const round2endtime = '2023-03-25T18:35:00+05:30';
            const round3endtime = '2023-03-25T18:30:00+05:30';
            const round4endtime = '2023-03-25T18:55:00+05:30';
            let clue;
            if (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round0endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) > new Date(huntstarttime)) {
                document.getElementById('heading').innerHTML = 'Round 1';
            } else if (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round1endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round0endtime)) {
                document.getElementById('heading').innerHTML = 'Round 2';
            } else if (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round2endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round1endtime)) {
                document.getElementById('heading').innerHTML = 'Round 3';
            } else if (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round3endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round2endtime)) {
                document.getElementById('heading').innerHTML = 'Round 4';
            } else if (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round4endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round3endtime)) {
                document.getElementById('heading').innerHTML = 'Final Round';
            }
            if (document.body.getBoundingClientRect().height > document.body.getBoundingClientRect().width) {
                document.getElementById('preview').style.maxHeight = '80vh';
                document.getElementById('preview').style.width = '80vw';
            } else if (document.body.getBoundingClientRect().height < document.body.getBoundingClientRect().width) {
                document.getElementById('preview').style.height = '80vh';
                document.getElementById('preview').style.maxWidth = '80vw';
            } else if (document.body.getBoundingClientRect().height = document.body.getBoundingClientRect().width) {
                document.getElementById('preview').style.height = '80vh';
                document.getElementById('preview').style.width = '80vw';
            }
            codeReader.getVideoInputDevices().then(videoInputDevices => {
                let deviceId = localStorage.getItem('defaultDeviceId');
                const rearCamera = videoInputDevices.find(device => {
                    if (device.label.includes('back') || device.label.includes('rear')) {
                        deviceId = device.deviceId;
                        localStorage.setItem('defaultDeviceId', deviceId);
                        return true;
                    }
                    return false;
                });
                if (!rearCamera) {
                    deviceId = localStorage.getItem('defaultDeviceId') || videoInputDevices[0].deviceId;
                    document.getElementById('preview').style.transform = 'scaleX(-1)';
                }
                codeReader.decodeFromInputVideoDevice(deviceId, 'preview')
                    .then(result => {
                        resetScanTimer();
                        if (round0.includes(result.text) == true) {
                            var database = firebase.database().ref('round0db');
                            const userInput = prompt("Please enter your group passkey: ");
                            if (userInput === null) {
                                window.location.reload();
                            }
                            const resulttosave = result.text;
                            const index = round0.indexOf(resulttosave);
                            const allowedindex1 = index * 3;
                            const allowedindex2 = (index * 3) + 1;
                            const allowedindex3 = (index * 3) + 2;
                            if (password.includes(userInput.toLowerCase())) {
                                if (userInput.toLowerCase() == password[allowedindex1] || userInput.toLowerCase() == password[allowedindex2] || userInput.toLowerCase() == password[allowedindex3]) {
                                    database.child(resulttosave).once('value').then(function (snapshot) {
                                        database.child(resulttosave).set({
                                            passkey: userInput.toLowerCase(),
                                            time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                                        });
                                        if (/*new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round0endtime) && */new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) > new Date(huntstarttime)) {
                                            firebase.database().ref('Clues').child('round0').once('value').then(function (snapshot) {
                                                document.getElementById('preview').style.display = 'none';
                                                switch (index) {
                                                    // 6 google maps links
                                                    case 0:
                                                        clue = snapshot.val().clue1;
                                                        break;
                                                    case 1:
                                                        clue = snapshot.val().clue2;
                                                        break;
                                                    case 2:
                                                        clue = snapshot.val().clue3;
                                                        break;
                                                    case 3:
                                                        clue = snapshot.val().clue4;
                                                        break;
                                                    case 4:
                                                        clue = snapshot.val().clue5;
                                                        break;
                                                    case 5:
                                                        clue = snapshot.val().clue6;
                                                        break;
                                                }
                                                document.getElementById('output').innerHTML = '<div id=\'iframecontainer\'><iframe id="iframe" src=\'' + clue + '\'></iframe></div><a id=\'link\' href=\'' + clue + '\'><i class="fa fa-external-link" aria-hidden="true"></i></a>';
                                                document.getElementById('output').style.display = 'flex';
                                            });
                                        } else {
                                            document.getElementById('output').innerHTML = 'This round is over or didn\'t start yet.';
                                            document.getElementById('preview').style.display = 'none';
                                            document.getElementById('output').style.display = 'flex';
                                        }
                                    });
                                } else {
                                    document.getElementById('output').innerHTML = 'This isn\'t your QR. Put it back.<br>If you think this is a mistake, recheck passkey or contact staff.';
                                    document.getElementById('output').style.display = 'flex';
                                    document.getElementById('preview').style.display = 'none';
                                }
                            } else {
                                document.getElementById('output').innerHTML = 'Incorrect passkey.<br>Try again or contact the staff if any issue persists.';
                                document.getElementById('output').style.display = 'flex';
                                document.getElementById('preview').style.display = 'none';
                            }
                        } else if (round1.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round3endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(huntstarttime)) {
                            var database = firebase.database().ref('round1db');
                            const userInput = prompt("Please enter your group passkey: ");
                            if (userInput === null) {
                                window.location.reload();
                            }
                            const resulttosave = result.text;
                            const index = round1.indexOf(resulttosave);
                            const allowedindex1 = index * 3;
                            const allowedindex2 = (index * 3) + 1;
                            const allowedindex3 = (index * 3) + 2;
                            if (password.includes(userInput.toLowerCase())) {
                                if (userInput.toLowerCase() == password[allowedindex1] || userInput.toLowerCase() == password[allowedindex2] || userInput.toLowerCase() == password[allowedindex3]) {
                                    database.child(resulttosave).once('value').then(function (snapshot) {
                                        if (snapshot.exists()) {
                                            var savedpasskey = snapshot.val().passkey;
                                            if (savedpasskey === userInput.toLowerCase()) {
                                                if (/*new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round1endtime) && */new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round0endtime)) {
                                                    document.getElementById('preview').style.display = 'none';
                                                    firebase.database().ref('Clues').child('round1').once('value').then(function (snapshot) {
                                                        switch (index) {
                                                            case 0:
                                                                clue = snapshot.val().clue1;
                                                                break;
                                                            case 1:
                                                                clue = snapshot.val().clue1;
                                                                break;
                                                            case 2:
                                                                clue = snapshot.val().clue2;
                                                                break;
                                                            case 3:
                                                                clue = snapshot.val().clue2;
                                                                break;
                                                            case 4:
                                                                clue = snapshot.val().clue3;
                                                                break;
                                                            case 5:
                                                                clue = snapshot.val().clue3;
                                                                break;
                                                            case 6:
                                                                clue = snapshot.val().clue4;
                                                                break;
                                                            case 7:
                                                                clue = snapshot.val().clue4;
                                                                break;
                                                        }
                                                        document.getElementById('output').innerHTML = '<div id=\'imagecontainer\'><img id="image" src=\'' + clue + '\' /></div><a id=\'link\' href=\'' + clue + '\'><i class="fa fa-external-link" aria-hidden="true"></i></a>';
                                                        document.getElementById('output').style.display = 'flex';
                                                    });
                                                } else {
                                                    document.getElementById('output').innerHTML = 'This round is over or didn\'t start yet.';
                                                    document.getElementById('preview').style.display = 'none';
                                                    document.getElementById('output').style.display = 'flex';
                                                }
                                            } else {
                                                document.getElementById('output').innerHTML = 'Your team has been eliminated.';
                                                document.getElementById('output').style.display = 'flex';
                                                document.getElementById('preview').style.display = 'none';
                                            }
                                        } else {
                                            database.child(resulttosave).set({
                                                passkey: userInput.toLowerCase(),
                                                time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                                            });
                                            if (/*new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round1endtime) && */new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round0endtime)) {
                                                document.getElementById('preview').style.display = 'none';
                                                firebase.database().ref('Clues').child('round1').once('value').then(function (snapshot) {
                                                    switch (index) {
                                                        case 0:
                                                            clue = snapshot.val().clue1;
                                                            break;
                                                        case 1:
                                                            clue = snapshot.val().clue1;
                                                            break;
                                                        case 2:
                                                            clue = snapshot.val().clue2;
                                                            break;
                                                        case 3:
                                                            clue = snapshot.val().clue2;
                                                            break;
                                                        case 4:
                                                            clue = snapshot.val().clue3;
                                                            break;
                                                        case 5:
                                                            clue = snapshot.val().clue3;
                                                            break;
                                                        case 6:
                                                            clue = snapshot.val().clue4;
                                                            break;
                                                        case 7:
                                                            clue = snapshot.val().clue4;
                                                            break;
                                                    }
                                                    document.getElementById('output').innerHTML = '<div id=\'imagecontainer\'><img id="image" src=\'' + clue + '\' /></div><a id=\'link\' href=\'' + clue + '\'><i class="fa fa-external-link" aria-hidden="true"></i></a>';
                                                    document.getElementById('output').style.display = 'flex';
                                                });
                                            } else {
                                                document.getElementById('output').innerHTML = 'Scan successful!\nThis round is over or didn\'t start yet.';
                                                document.getElementById('output').style.backgroundColor = "#10a96e";
                                                document.getElementById('preview').style.display = 'none';
                                                document.getElementById('output').style.display = 'flex';
                                            }
                                        }
                                    });
                                } else {
                                    document.getElementById('output').innerHTML = 'This isn\'t your QR. Put it back.<br>If you think this is a mistake, recheck passkey or contact staff.';
                                    document.getElementById('output').style.display = 'flex';
                                    document.getElementById('preview').style.display = 'none';
                                }
                            } else {
                                document.getElementById('output').innerHTML = 'Incorrect passkey.<br>Try again or contact the staff if any issue persists.';
                                document.getElementById('output').style.display = 'flex';
                                document.getElementById('preview').style.display = 'none';
                            }
                        } else if (round2.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round3endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(huntstarttime)) {
                            var database = firebase.database().ref('round2db');
                            firebase.database().ref('round1db').once('value').then(snapshot => {
                                try {
                                    snapshot.forEach(childSnapshot => {
                                        const round1pass = childSnapshot.child("passkey").val();
                                        round1teamssplice.push(round1pass);
                                    });
                                    round1teams.splice(0, 0, ...round1teamssplice);
                                    const userInput = prompt("Please enter your group passkey: ");
                                    if (userInput === null) {
                                        window.location.reload();
                                    }
                                    const resulttosave = result.text;
                                    const index = round2.indexOf(resulttosave);
                                    const allowedindex1 = index * 2;
                                    const allowedindex2 = (index * 2) + 1;
                                    if (round1teams.includes(userInput.toLowerCase())) {
                                        if (userInput.toLowerCase() == round1teams[allowedindex1] || userInput.toLowerCase() == round1teams[allowedindex2]) {
                                            database.child(resulttosave).once('value').then(function (snapshot) {
                                                if (snapshot.exists()) {
                                                    var savedpasskey = snapshot.val().passkey;
                                                    if (savedpasskey === userInput.toLowerCase()) {
                                                        if (/*new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round2endtime) && */new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round1endtime)) {
                                                            document.getElementById('preview').style.display = 'none';
                                                            firebase.database().ref('Clues').child('round2').once('value').then(function (snapshot) {
                                                                switch (index) {
                                                                    case 0:
                                                                        clue = snapshot.val().clue1;
                                                                        break;
                                                                    case 1:
                                                                        clue = snapshot.val().clue1;
                                                                        break;
                                                                    case 2:
                                                                        clue = snapshot.val().clue2;
                                                                        break;
                                                                    case 3:
                                                                        clue = snapshot.val().clue2;
                                                                        break;
                                                                }
                                                                document.getElementById('output').innerHTML = '<div id=\'iframecontainer\'><iframe id="iframe" src=\'' + clue + '\'></iframe></div><a id=\'link\' href=\'' + clue + '\'><i class="fa fa-external-link" aria-hidden="true"></i></a>';
                                                                document.getElementById('output').style.display = 'flex';
                                                            });
                                                        } else {
                                                            document.getElementById('output').innerHTML = 'This round is over or didn\'t start yet.';
                                                            document.getElementById('preview').style.display = 'none';
                                                            document.getElementById('output').style.display = 'flex';
                                                        }
                                                    } else {
                                                        document.getElementById('output').innerHTML = 'Your team has been eliminated.';
                                                        document.getElementById('output').style.display = 'flex';
                                                        document.getElementById('preview').style.display = 'none';
                                                    }
                                                } else {
                                                    database.child(resulttosave).set({
                                                        passkey: userInput.toLowerCase(),
                                                        time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                                                    });
                                                    if (/*new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round2endtime) && */new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round1endtime)) {
                                                        document.getElementById('preview').style.display = 'none';
                                                        firebase.database().ref('Clues').child('round2').once('value').then(function (snapshot) {
                                                            switch (index) {
                                                                case 0:
                                                                    clue = snapshot.val().clue1;
                                                                    break;
                                                                case 1:
                                                                    clue = snapshot.val().clue1;
                                                                    break;
                                                                case 2:
                                                                    clue = snapshot.val().clue2;
                                                                    break;
                                                                case 3:
                                                                    clue = snapshot.val().clue2;
                                                                    break;
                                                            }
                                                            document.getElementById('output').innerHTML = '<div id=\'iframecontainer\'><iframe id="iframe" src=\'' + clue + '\'></iframe></div><a id=\'link\' href=\'' + clue + '\'><i class="fa fa-external-link" aria-hidden="true"></i></a>';
                                                            document.getElementById('output').style.display = 'flex';
                                                        });
                                                    } else {
                                                        document.getElementById('output').innerHTML = 'Scan successful!\nThis round is over or didn\'t start yet.';
                                                        document.getElementById('output').style.backgroundColor = "#10a96e";
                                                        document.getElementById('preview').style.display = 'none';
                                                        document.getElementById('output').style.display = 'flex';
                                                    }
                                                }
                                            });
                                        } else {
                                            document.getElementById('output').innerHTML = 'This isn\'t your QR. Put it back.<br>If you think this is a mistake, recheck passkey or contact staff.';
                                            document.getElementById('output').style.display = 'flex';
                                            document.getElementById('preview').style.display = 'none';
                                        }
                                    } else if (round1teams.includes(userInput.toLowerCase()) == false && password.includes(userInput.toLowerCase()) == true) {
                                        document.getElementById('output').innerHTML = 'Your team has been eliminated.';
                                        document.getElementById('output').style.display = 'flex';
                                        document.getElementById('preview').style.display = 'none';
                                    } else {
                                        document.getElementById('output').innerHTML = 'Incorrect passkey.<br>Try again or contact the staff if any issue persists.';
                                        document.getElementById('output').style.display = 'flex';
                                        document.getElementById('preview').style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('Error retrieving data from Firebase: ', error);
                                }
                            });
                        } else if (round3.includes(result.text) == true) {
                            var database = firebase.database().ref('round3db');
                            firebase.database().ref('round2db').once('value').then(snapshot => {
                                try {
                                    snapshot.forEach(childSnapshot => {
                                        const round2pass = childSnapshot.child("passkey").val();
                                        round2teams.push(round2pass);
                                    });
                                    const userInput = prompt("Please enter your group passkey: ");
                                    if (userInput === null) {
                                        window.location.reload();
                                    }
                                    const resulttosave = result.text;
                                    const index = round3.indexOf(resulttosave);
                                    const allowedindex1 = index * 2;
                                    const allowedindex2 = (index * 2) + 1;
                                    if (round2teams.includes(userInput.toLowerCase())) {
                                        if (userInput.toLowerCase() == round2teams[allowedindex1] || userInput.toLowerCase() == round2teams[allowedindex2]) {
                                            database.child(resulttosave).once('value').then(function (snapshot) {
                                                if (snapshot.exists()) {
                                                    var savedpasskey = snapshot.val().passkey;
                                                    if (savedpasskey === userInput.toLowerCase()) {
                                                        document.getElementById('preview').style.display = 'none';
                                                        switch (index) {
                                                            case 0:
                                                                document.getElementById('output').innerHTML = 'Congratulations!<br>You are in the finals!';
                                                                break;
                                                            case 1:
                                                                document.getElementById('output').innerHTML = 'Congratulations!<br>You are in the finals!';
                                                                break;
                                                        }
                                                        document.getElementById('output').style.display = 'flex';
                                                        document.getElementById('output').style.backgroundColor = "#10a96e";

                                                    } else {
                                                        document.getElementById('output').innerHTML = 'Your team has been eliminated.';
                                                        document.getElementById('output').style.display = 'flex';
                                                        document.getElementById('preview').style.display = 'none';
                                                    }
                                                } else {
                                                    database.child(resulttosave).set({
                                                        passkey: userInput.toLowerCase(),
                                                        time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                                                    });
                                                    document.getElementById('preview').style.display = 'none';
                                                    switch (index) {
                                                        case 0:
                                                            document.getElementById('output').innerHTML = 'Congratulations!<br>You are in the finals!';
                                                            break;
                                                        case 1:
                                                            document.getElementById('output').innerHTML = 'Congratulations!<br>You are in the finals!';
                                                            break;
                                                    }
                                                    document.getElementById('output').style.display = 'flex';
                                                    document.getElementById('output').style.backgroundColor = "#10a96e";
                                                }
                                            });
                                        } else {
                                            document.getElementById('output').innerHTML = 'This isn\'t your QR. Put it back.<br>If you think this is a mistake, recheck passkey or contact staff.';
                                            document.getElementById('output').style.display = 'flex';
                                            document.getElementById('preview').style.display = 'none';
                                        }
                                    } else if (round2teams.includes(userInput.toLowerCase()) == false && password.includes(userInput.toLowerCase()) == true) {
                                        document.getElementById('output').innerHTML = 'Your team has been eliminated.';
                                        document.getElementById('output').style.display = 'flex';
                                        document.getElementById('preview').style.display = 'none';
                                    } else {
                                        document.getElementById('output').innerHTML = 'Incorrect passkey.<br>Try again or contact the staff if any issue persists.';
                                        document.getElementById('output').style.display = 'flex';
                                        document.getElementById('preview').style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('Error retrieving data from Firebase: ', error);
                                }
                            });
                        } else if (round4.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(round4endtime) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round3endtime)) {
                            var database = firebase.database().ref('round4db');
                            const scannedpoints = parseInt(result.text.match(/\d+/g).join(''));
                            firebase.database().ref('round3db').once('value').then(snapshot => {
                                try {
                                    snapshot.forEach(childSnapshot => {
                                        const round2pass = childSnapshot.child("passkey").val();
                                        round3teams.push(round2pass);
                                    });
                                    const userInput = prompt("Please enter your group passkey: ");
                                    if (userInput === null) {
                                        window.location.reload();
                                    }
                                    const resulttosave = result.text;
                                    const index = round4.indexOf(resulttosave);
                                    if (round3teams.includes(userInput.toLowerCase())) {
                                        if (userInput.toLowerCase() == round3teams[0] || userInput.toLowerCase() == round3teams[1]) {
                                            database.child(resulttosave).once('value').then(function (snapshot) {
                                                if (snapshot.exists()) {
                                                    document.getElementById('output').innerHTML = 'This QR is already scanned.';
                                                    document.getElementById('output').style.display = 'flex';
                                                    document.getElementById('preview').style.display = 'none';
                                                } else {
                                                    database.child(userInput.toLowerCase()).once('value').then(function (snapshot) {
                                                        if (snapshot.val() !== null) {
                                                            const oldpoints = snapshot.val().points;
                                                            const totalpoints = oldpoints + scannedpoints;
                                                            database.child(userInput.toLowerCase()).set({
                                                                points: totalpoints
                                                            });
                                                            database.child(resulttosave).set({
                                                                passkey: userInput.toLowerCase(),
                                                                time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                                                            });
                                                        } else {
                                                            const oldpoints = 0;
                                                            const totalpoints = oldpoints + scannedpoints;
                                                            database.child(userInput.toLowerCase()).set({
                                                                points: totalpoints
                                                            });
                                                            database.child(resulttosave).set({
                                                                passkey: userInput.toLowerCase(),
                                                                time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                                                            });
                                                        }
                                                        document.getElementById('preview').style.display = 'none';
                                                        document.getElementById('output').innerHTML = 'Your team just scanned and recieved ' + scannedpoints + ' points.';
                                                        document.getElementById('output').style.display = 'flex';
                                                        document.getElementById('output').style.backgroundColor = "#10a96e";
                                                    });
                                                }
                                            });
                                        } else {
                                            document.getElementById('output').innerHTML = 'This isn\'t your QR. Put it back.<br>If you think this is a mistake, recheck passkey or contact staff.';
                                            document.getElementById('output').style.display = 'flex';
                                            document.getElementById('preview').style.display = 'none';
                                        }
                                    } else if (round3teams.includes(userInput.toLowerCase()) == false && password.includes(userInput.toLowerCase()) == true) {
                                        document.getElementById('output').innerHTML = 'Your team has been eliminated.';
                                        document.getElementById('output').style.display = 'flex';
                                        document.getElementById('preview').style.display = 'none';
                                    } else {
                                        document.getElementById('output').innerHTML = 'Incorrect passkey.<br>Try again or contact the staff if any issue persists.';
                                        document.getElementById('output').style.display = 'flex';
                                        document.getElementById('preview').style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('Error retrieving data from Firebase: ', error);
                                }
                            });
                        } else if (round0.includes(result.text) == false && round1.includes(result.text) == false && round2.includes(result.text) == false && round3.includes(result.text) == false && round4.includes(result.text) == false) {
                            document.getElementById('output').innerHTML = 'Detected QR is not a part of this QR hunt.';
                            document.getElementById('output').style.display = 'flex';
                            document.getElementById('preview').style.display = 'none';
                        } else if ((round0.includes(result.text) == true || round1.includes(result.text) == true || round2.includes(result.text) == true || round3.includes(result.text) == true || round4.includes(result.text) == true) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round4endtime)) {
                            document.getElementById('output').innerHTML = 'This QR hunt has been ended.';
                            document.getElementById('output').style.display = 'flex';
                            document.getElementById('preview').style.display = 'none';
                        } else if ((round0.includes(result.text) == true || round1.includes(result.text) == true || round2.includes(result.text) == true || round3.includes(result.text) == true || round4.includes(result.text) == true) && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) < new Date(huntstarttime)) {
                            document.getElementById('output').innerHTML = 'This QR hunt has not been started yet.';
                            document.getElementById('output').style.display = 'flex';
                            document.getElementById('preview').style.display = 'none';
                        } else if ((round0.includes(result.text) == true && (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round0endtime) || new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }))) < new Date(huntstarttime)) || (round1.includes(result.text) == true && (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round1endtime) || new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }))) < new Date(round0endtime)) || (round2.includes(result.text) == true && (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round2endtime) || new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }))) < new Date(round1endtime)) || (round3.includes(result.text) == true && (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round3endtime) || new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }))) < new Date(round2endtime)) || (round4.includes(result.text) == true && (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(round4endtime) || new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }))) < new Date(round3endtime))) {
                            document.getElementById('output').innerHTML = 'This round is over or hasn\'t been started yet.';
                            document.getElementById('output').style.display = 'flex';
                            document.getElementById('preview').style.display = 'none';
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        if (err.message == "Permission denied" || err.message == "Permission dismissed") {
                            document.getElementById('output').innerHTML = 'Missing the permission to use camera. Can\'t proceed further.';
                            document.getElementById('output').style.display = 'flex';
                            document.getElementById('preview').style.display = 'none';
                        } else {
                            window.alert('This is an unanticipated error. Please report to staff. \n' + err.message + '.');
                        }
                        resetScanTimer();
                    });
                startScanTimer();
            });
        });
    </script>

</body>

</html>
